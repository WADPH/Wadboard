
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>WADPH Dashboard</title>
  <link rel="icon" type="image/png" href="images/wadboard_logo.png">

  <style>
  :root {
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --shadow-card: 0 32px 64px rgba(0,0,0,0.45);

    --green-bg: rgba(16,185,129,0.18);
    --green-text: #10b981;
    --green-border: rgba(16,185,129,0.4);

    --red-bg: rgba(239,68,68,0.18);
    --red-text: #ef4444;
    --red-border: rgba(239,68,68,0.4);

    --drag-ring: #7c3aed;
    --drag-bg: rgba(124,58,237,0.1);

    --transition-fast: 0.15s ease;
  }

  :root[data-theme="dark"] {
    --bg: #0e0f14;
    --surface: #171923;
    --surface-alt: #1f2333;
    --border: #2b3050;

    --text-main: #ecf0ff;
    --text-dim: #7b82b4;
    --text-mid: #aeb6ff;

    --btn-bg: #4247a3;
    --btn-bg-hover: #5257c7;
    --danger-bg: #dc2626;
    --danger-bg-hover: #ef4444;

    --accent-bg: linear-gradient(135deg,#7c3aed 0%,#06b6d4 100%);
    --accent-text: #ffffff;
    --chip-shadow: 0 6px 20px rgba(124,58,237,0.25);


    --scrollbar-track: #171923;
    --scrollbar-thumb: #3a3f6b;
    --scrollbar-thumb-hover: #4f55a8;
  }

  :root[data-theme="light"] {
    --bg: #f6f7ff;
    --surface: #ffffff;
    --surface-alt: #eef1ff;
    --border: #d7dbff;

    --text-main: #12122b;
    --text-dim: #676c93;
    --text-mid: #333a83;

    --btn-bg: #333a83;
    --btn-bg-hover: #3f49ad;
    --danger-bg: #dc2626;
    --danger-bg-hover: #ef4444;

    --accent-bg: linear-gradient(135deg,#4f46e5 0%,#0ea5e9 100%);
    --accent-text: #ffffff;
    --chip-shadow: 0 6px 20px rgba(79,70,229,0.25);


    --scrollbar-track: #eef1ff;
    --scrollbar-thumb: #b5bcff;
    --scrollbar-thumb-hover: #7c84ff;
  }

  * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
  html, body { height: 100%; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text-main);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
    transition: background var(--transition-fast), color var(--transition-fast);
  }

  .page { min-height: 100vh; display: flex; flex-direction: column; }
  .wrap {
    width: min(1400px, 96vw);
    margin: 0 auto;
    padding: 2rem 0 3rem;
    flex: 1 0 auto;
  }

  .header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1rem;
    align-items: flex-start;
  }

  .brand-row { display: flex; align-items: center; gap: .9rem; flex-wrap: wrap; }

  .brand-mark {
    background-image: var(--accent-bg);
    color: var(--accent-text);
    font-weight: 700;
    font-size: .8rem;
    line-height: 1.2;
    border-radius: var(--radius-xl);
    padding: .5rem .75rem;
    box-shadow: 0 18px 36px rgba(0,0,0,0.35);
  }

  .title h1 {
    margin: 0;
    font-size: 1.55rem;
    letter-spacing: -0.02em;
  }

  .title p {
    margin: .25rem 0 0;
    font-size: .8rem;
    color: var(--text-dim);
  }

  .badge {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    padding: .6rem .8rem;
    font-size: .7rem;
    color: var(--text-dim);
    box-shadow: var(--shadow-card);
  }
  .badge b { color: var(--text-mid); }

  .toolbar { display: flex; gap: .5rem; flex-wrap: wrap; }
  .icon-btn {
    cursor: pointer;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-main);
    border-radius: var(--radius-xl);
    padding: .6rem .75rem;
    font-weight: 700;
    font-size: .75rem;
    box-shadow: var(--shadow-card);
    transition: border-color var(--transition-fast), background var(--transition-fast), opacity var(--transition-fast);
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .icon-btn:hover { border-color: var(--drag-ring); }
  .icon-btn:disabled {
    opacity: 0.6;
    cursor: default;
  }
  .icon-btn:focus-visible {
    outline: 2px solid var(--drag-ring);
    outline-offset: 2px;
  }

  .btn-icon {
    width: 1.1rem;
    height: 1.1rem;
    fill: currentColor;
    flex: 0 0 auto;
    display: block;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  :root[data-theme="light"] .icon-theme-sun { display: none; }
  :root[data-theme="dark"]  .icon-theme-moon { display: none; }

  @keyframes spin { to { transform: rotate(360deg); } }
  .icon-refresh { transform-origin: 50% 50%; }
  .icon-btn[aria-busy="true"] .icon-refresh { animation: spin 0.9s linear infinite; }

  .section { margin-top: 2rem; }
  .section-head {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: .9rem;
  }
  .section-head h2 { margin: 0; font-size: 1.1rem; }
  .section-count { font-size: .7rem; color: var(--text-dim); }

  .grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
  }
  @media(min-width: 780px){
    .grid {
      grid-template-columns: repeat(2,1fr);
    }
  }
  @media(min-width: 780px){
    .full-span {
      grid-column: span 2;
    }
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-2xl);
    padding: 1rem;
    box-shadow: var(--shadow-card);
    display: flex; flex-direction: column; gap: .9rem;
    transition: background var(--transition-fast), border-color var(--transition-fast);
    min-width: 0;
  }

  .card[draggable="true"] { cursor: grab; }
  .card.drag-over { border-color: var(--drag-ring); background: var(--drag-bg); }

  .svc-top { display: flex; justify-content: space-between; gap: .75rem; align-items: flex-start; }
  .svc-name { display: flex; align-items: center; gap: .5rem; flex-wrap: wrap; font-weight: 700; }

  .chip-up, .chip-down {
    display: inline-flex; align-items: center;
    font-size: .65rem; font-weight: 800; padding: .25rem .5rem;
    border-radius: 999px; border: 1px solid transparent; box-shadow: var(--chip-shadow);
  }
  .chip-up {
    background: var(--green-bg); color: var(--green-text); border-color: var(--green-border);
  }
  .chip-down {
    background: var(--red-bg); color: var(--red-text); border-color: var(--red-border);
  }

  .svc-url { color: var(--text-dim); font-size: .78rem; word-break: break-all; }
  .svc-notes {
    color: var(--text-mid);
    font-size: .78rem;
    word-break: break-word;
    white-space: pre-line;
  }

  .btn-row { display: flex; gap: .5rem; flex-wrap: wrap; }
  .btn {
    cursor: pointer; background: var(--btn-bg); color: #fff; border: 0;
    border-radius: var(--radius-xl); padding: .48rem .75rem; font-weight: 700; font-size: .72rem;
    transition: background var(--transition-fast);
    text-decoration: none; display: inline-flex; align-items: center; gap: .35rem;
  }
  .btn.btn-icon-only { padding: .48rem .55rem; gap: 0; }
  .btn:hover { background: var(--btn-bg-hover); }
  .btn-danger { background: var(--danger-bg); }
  .btn-danger:hover { background: var(--danger-bg-hover); }

  .meta { display: flex; justify-content: space-between; align-items: flex-start; gap: .9rem; flex-wrap: wrap; }
  .meta .group { font-size: .78rem; color: var(--text-dim); }
  .meta .group b { color: var(--text-mid); display: block; margin-bottom: .2rem; }

  .link-row { display: flex; justify-content: space-between; gap: .75rem; align-items: flex-start; }
  .link-left { display: flex; gap: .75rem; align-items: flex-start; min-width: 0; }
  .link-icon { font-size: 1.55rem; line-height: 1; }
  .link-title { font-weight: 800; margin: 0 0 .25rem; }
  .link-url { font-size: .78rem; color: var(--text-dim); word-break: break-all; }
  .link-notes {
    font-size: .78rem;
    color: var(--text-mid);
    word-break: break-word;
    white-space: pre-line;
  }

  .wol-row { display: flex; justify-content: space-between; gap: .75rem; align-items: flex-start; }
  .wol-left { display: flex; flex-direction: column; gap: .4rem; min-width:0; }
  .wol-title { font-weight: 800; margin: 0; }
  .wol-notes {
    font-size: .78rem;
    color: var(--text-mid);
    word-break: break-word;
    white-space: pre-line;
  }
  .wol-meta {
    font-size: .72rem;
    color: var(--text-dim);
    word-break: break-word;
    white-space: pre-line;
  }
  .wol-chip {
    display:inline-block;
    font-size:.65rem;
    font-weight:700;
    padding:.25rem .5rem;
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--surface-alt);
    color:var(--text-mid);
  }

  .hidden { display: none !important; }

  .overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    display: flex; align-items: center; justify-content: center; z-index: 9999;
  }

  /* Toast notifications (action results + errors) */
  .toast-stack {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    z-index: 10000;
    width: min(90vw, 360px);
  }
  .toast {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 4px solid var(--drag-ring);
    border-radius: var(--radius-xl);
    padding: 0.8rem 0.9rem;
    box-shadow: var(--shadow-card);
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .toast-success { border-left-color: var(--green-text); }
  .toast-error { border-left-color: var(--red-text); }
  .toast-title { font-weight: 800; font-size: 0.85rem; }
  .toast-body { font-size: 0.78rem; color: var(--text-mid); }
  .toast-detail {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.72rem;
    color: var(--text-dim);
    word-break: break-word;
  }

  /* Inline form status */
  .inline-status {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-dim);
  }
  .inline-status.error { color: var(--red-text); }
  .inline-status.success { color: var(--green-text); }
.modal {
  width: min(92vw, 520px);
  max-height: calc(100vh - 2rem);   /* ÐºÐ»ÑŽÑ‡ÐµÐ²Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° */
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-2xl);
  box-shadow: var(--shadow-card);
  padding: 1rem 1.25rem 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  overflow: hidden;                 /* Ð²Ð°Ð¶Ð½Ð¾ */
}

  .modal-top { display: flex; justify-content: space-between; gap: .75rem; align-items: center; }

.modal-body {
  overflow-y: auto;
  flex: 1 1 auto;        /* Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð²ÑÑ‘ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾ */
  display: flex;
  flex-direction: column;
  gap: 1rem;
  padding-right: 0.25rem;
}

 
 .tabs { display: flex; gap: .5rem; flex-wrap: wrap; }
  .tab {
    cursor: pointer; background-image: var(--accent-bg); color: var(--accent-text);
    border: 0; border-radius: var(--radius-xl); padding: .5rem .75rem; font-weight: 800; font-size: .72rem;
    box-shadow: 0 16px 32px rgba(0,0,0,0.3);
  }
  .close {
    cursor: pointer; background: var(--surface-alt); border: 1px solid var(--border);
    border-radius: var(--radius-xl); padding: .5rem .75rem; font-weight: 800; font-size: .72rem;
  }

  .form {
    background: var(--surface-alt); border: 1px solid var(--border);
    border-radius: var(--radius-xl); padding: 1rem;
  }
  .form h3 { margin: 0 0 .75rem; }
  .field { display: flex; flex-direction: column; gap: .35rem; margin-bottom: .75rem; }
  .label { font-size: .75rem; color: var(--text-mid); font-weight: 700; }
  .input, .textarea, select.input {
    background: var(--surface); border: 1px solid var(--border); color: var(--text-main);
    border-radius: var(--radius-xl); padding: .6rem .75rem; font-size: .85rem; outline: none;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }
  .textarea { min-height: 84px; resize: vertical; }
  .input:focus, .textarea:focus, select.input:focus {
    border-color: var(--drag-ring); box-shadow: 0 0 0 2px rgba(124,58,237,0.25);
  }
  .submit { width: 100%; }

  .footer {
    width: 100%;
    margin-top: auto;
    background: var(--surface);
    border-top: 1px solid var(--border);
    color: var(--text-dim);
  }
  .footer .inner {
    width: min(1400px, 96vw);
    margin: 0 auto; padding: .9rem 0;
    font-size: .72rem; text-align: center;
  }

  /* Host banner styles */
  .host-banner {
    max-width: 720px;
    margin: 1.5rem auto 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.9rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-2xl);
    padding: 1.1rem 1.5rem;
    box-shadow: var(--shadow-card);
    text-align: center;
  }

  .host-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  .host-title {
    font-weight: 800;
    font-size: 1.05rem;
  }

  .host-sub {
    color: var(--text-dim);
    font-size: 0.78rem;
  }

  .host-stats {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.45rem;
  }

  .host-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--surface-alt);
    font-size: 0.78rem;
    color: var(--text-mid);
    box-shadow: var(--chip-shadow);
    white-space: nowrap;
  }

  .host-chip b {
    color: var(--text-main);
    font-weight: 800;
  }

  .host-actions {
    margin-top: 0.4rem;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.45rem;
  }

  .host-actions-note {
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  /* SSH actions editor */
  .ssh-section {
    display: flex;
    flex-direction: column;
    gap: .5rem;
  }
  .ssh-row {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    margin-bottom: .25rem;
  }
  .ssh-row .ssh-input {
    flex: 1 1 160px;
  }
  .ssh-row .btn {
    flex: 0 0 auto;
  }






/* ===== Custom scrollbar (modal only) ===== */
.modal-body::-webkit-scrollbar {
  width: 10px;
}

.modal-body::-webkit-scrollbar-track {
  background: var(--scrollbar-track);
  border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--scrollbar-thumb);
  border-radius: 10px;
  border: 2px solid var(--scrollbar-track);
}

  .modal-body::-webkit-scrollbar-thumb:hover {
   background: var(--scrollbar-thumb-hover);
  }

  /* ===== Health page ===== */
  .health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1rem;
  }

  @media (min-width: 900px) {
    .health-grid {
      grid-template-columns: 1.35fr 1fr;
      grid-template-areas:
        "cpu system"
        "cpu memory"
        "cpu storage";
      align-items: stretch;
    }

    .health-card-cpu { grid-area: cpu; }
    .health-card-system { grid-area: system; }
    .health-card-memory { grid-area: memory; }
    .health-card-storage { grid-area: storage; }

    .health-card-cpu .ring-wrap {
      width: 260px;
      height: 260px;
    }

    .health-card-cpu .ring {
      width: 260px;
      height: 260px;
    }
  }

  .health-card {
    display: flex;
    flex-direction: column;
  }

  .health-card-cpu .ring-wrap {
    margin: auto;
  }

  .health-card h3 {
    margin: 0 0 .75rem;
    font-size: 1rem;
    color: var(--text-mid);
  }

  .health-kv {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    font-size: .9rem;
    padding: .25rem 0;
  }

  .health-kv span:first-child {
    color: var(--text-dim);
  }

  .health-note {
    margin-top: .6rem;
    font-size: .8rem;
    color: var(--text-dim);
  }

  .health-card-footer {
    margin-top: auto;
    padding-top: .9rem;
  }

  .health-card-cpu #health-cpu-note {
    margin-top: .35rem;
    align-self: flex-start;
  }

  .health-error {
    margin-top: 1rem;
    padding: .75rem 1rem;
    border: 1px solid var(--red-border);
    background: var(--red-bg);
    color: var(--red-text);
    border-radius: var(--radius-xl);
  }

  .bar {
    height: .75rem;
    background: rgba(255,255,255,0.08);
    border: 1px solid var(--border);
    border-radius: 999px;
    overflow: hidden;
  }

  .bar > span {
    display: block;
    height: 100%;
    width: 0%;
    background-image: var(--accent-bg);
    transition: width var(--transition-fast);
  }

  .ring-wrap {
    position: relative;
    width: 190px;
    height: 190px;
    margin: .75rem auto;
  }

  .ring {
    width: 190px;
    height: 190px;
    transform: rotate(-90deg);
  }

  .ring-bg {
    stroke: rgba(255,255,255,0.12);
    stroke-width: 12;
    fill: none;
  }

  .ring-fg {
    stroke: #10b981;
    stroke-width: 12;
    fill: none;
    stroke-linecap: round;
    transition: stroke var(--transition-fast);
  }

  .ring-center {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    pointer-events: none;
  }

  .ring-big {
    font-weight: 800;
    font-size: 1.5rem;
  }

  .ring-small {
    font-size: .8rem;
    color: var(--text-dim);
    margin-top: .15rem;
  }




  </style>
</head>
<body>
<div class="page" id="home-page">
  <div class="wrap">
    <header class="header">
      <div class="brand-row">
        <div class="brand-mark">WELCOME</div>
        <div class="title">
          <h1>Wadboard</h1>
          <p>Internal Services And Status</p>
        </div>
      </div>

      <div style="display:flex; gap:.6rem; flex-wrap:wrap; align-items:flex-start;">
        <div class="badge"><b>Auto-refresh</b> Every 10s</div>
        <div class="toolbar">
          <button class="icon-btn" id="theme-toggle" type="button" aria-label="Theme" title="Theme">
            <svg class="btn-icon icon-theme-moon" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"></path>
              <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.73 1.73 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.73 1.73 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.73 1.73 0 0 0 1.097-1.097zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"></path>
            </svg>
            <svg class="btn-icon icon-theme-sun" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"></path>
            </svg>
            <span class="sr-only">Theme</span>
          </button>
          <button class="icon-btn" id="refresh-btn" type="button" aria-label="Refresh" title="Refresh">
            <svg class="btn-icon icon-refresh" viewBox="0 0 16 16" aria-hidden="true">
              <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"></path>
              <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"></path>
            </svg>
            <span class="sr-only">Refresh</span>
          </button>
          <button class="icon-btn" id="health-btn" type="button" aria-label="Health" title="Health">
            <svg class="btn-icon" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M1.475 9C2.702 10.84 4.779 12.871 8 15c3.221-2.129 5.298-4.16 6.525-6H12a.5.5 0 0 1-.464-.314l-1.457-3.642-1.598 5.593a.5.5 0 0 1-.945.049L5.889 6.568l-1.473 2.21A.5.5 0 0 1 4 9z"></path>
              <path d="M.88 8C-2.427 1.68 4.41-2 7.823 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C11.59-2 18.426 1.68 15.12 8h-2.783l-1.874-4.686a.5.5 0 0 0-.945.049L7.921 8.956 6.464 5.314a.5.5 0 0 0-.88-.091L3.732 8z"></path>
            </svg>
            <span class="sr-only">Health</span>
          </button>
          <button class="icon-btn" id="admin-toggle" type="button" aria-label="Settings" title="Settings">
            <svg class="btn-icon" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"></path>
            </svg>
            <span class="sr-only">Settings</span>
          </button>
          <button class="icon-btn hidden" id="open-modal" type="button" aria-label="Add" title="Add">
            <svg class="btn-icon" viewBox="0 0 16 16" aria-hidden="true">
              <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"></path>
            </svg>
            <span class="sr-only">Add</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Host status banner -->
    <section class="section">
      <div id="host-banner" class="host-banner">
        <div class="host-left">
          <div class="host-title">Device Maintenance</div>
          <div class="host-sub" id="host-updated">â€”</div>
        </div>
        <div class="host-stats" id="host-stats">
          <!-- filled by JS -->
        </div>
        <div class="host-actions" id="host-actions">
          <!-- maintenance buttons -->
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>Services</h2>
        <div class="section-count" id="svc-count">0 total</div>
      </div>
      <div class="grid" id="svc-grid"></div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>Quick Links</h2>
        <div class="section-count" id="lnk-count">0 total</div>
      </div>
      <div class="grid" id="lnk-grid"></div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>WOL</h2>
        <div class="section-count" id="wol-count">0 total</div>
      </div>
      <div class="grid" id="wol-grid"></div>
    </section>

  </div>

  <footer class="footer">
    <div class="inner">â€”â€” Wadboard â€”â€”<br>â€” Control Everything â€”</div>
  </footer>
</div>

<div class="page hidden" id="health-page">
  <div class="wrap">
    <header class="header">
      <div class="brand-row">
        <div class="brand-mark">WELCOME</div>
        <div class="title">
          <h1>Health</h1>
          <p>Host status & resources</p>
        </div>
      </div>

      <div style="display:flex; gap:.6rem; flex-wrap:wrap; align-items:flex-start;">
        <div class="badge"><b>Auto-refresh</b> Every 10s</div>
      <div class="toolbar">
          <button class="icon-btn" id="theme-toggle-health" type="button" aria-label="Theme" title="Theme">
            <svg class="btn-icon icon-theme-moon" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"></path>
              <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.73 1.73 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.73 1.73 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.73 1.73 0 0 0 1.097-1.097zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"></path>
            </svg>
            <svg class="btn-icon icon-theme-sun" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"></path>
            </svg>
            <span class="sr-only">Theme</span>
          </button>
          <button class="icon-btn" id="health-refresh-btn" type="button" aria-label="Refresh" title="Refresh">
            <svg class="btn-icon icon-refresh" viewBox="0 0 16 16" aria-hidden="true">
              <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"></path>
              <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"></path>
            </svg>
            <span class="sr-only">Refresh</span>
          </button>
          <button class="icon-btn" id="health-home-btn" type="button" aria-label="Home" title="Home">
            <svg class="btn-icon" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293z"></path>
              <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293z"></path>
            </svg>
            <span class="sr-only">Home</span>
          </button>
          <button class="icon-btn" id="admin-toggle-health" type="button" aria-label="Settings" title="Settings">
            <svg class="btn-icon" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"></path>
            </svg>
            <span class="sr-only">Settings</span>
          </button>
        </div>
      </div>
    </header>

    <section class="section">
      <div class="section-head">
        <h2>Host</h2>
        <div class="section-count" id="health-updated">â€”</div>
      </div>

        <div class="health-grid">
        <div class="card health-card health-card-cpu">
          <h3>CPU</h3>
          <div class="ring-wrap">
            <svg class="ring" viewBox="0 0 120 120" aria-label="CPU usage">
              <circle class="ring-bg" cx="60" cy="60" r="52"></circle>
              <circle class="ring-fg" id="health-cpu-ring" cx="60" cy="60" r="52"></circle>
            </svg>
            <div class="ring-center">
              <div class="ring-big" id="health-cpu-pct">â€”%</div>
            </div>
          </div>
          <div class="health-card-footer">
            <div class="health-kv"><span>Load</span><span id="health-cpu-load">â€”</span></div>
            <div class="health-note" id="health-cpu-note"></div>
          </div>
        </div>

        <div class="card health-card health-card-memory">
          <h3>Memory</h3>
          <div class="bar"><span id="health-ram-bar"></span></div>
          <div class="health-card-footer">
            <div class="health-kv"><span>Used</span><span id="health-ram-text">â€”</span></div>
            <div class="health-note" id="health-ram-note"></div>
          </div>
        </div>

        <div class="card health-card health-card-storage">
          <h3>Storage</h3>
          <div class="bar"><span id="health-disk-bar"></span></div>
          <div class="health-card-footer">
            <div class="health-kv"><span>Mount</span><span id="health-disk-text">â€”</span></div>
            <div class="health-note" id="health-disk-note"></div>
          </div>
        </div>

        <div class="card health-card health-card-system">
          <h3>System</h3>
          <div class="health-kv"><span>Hostname</span><span id="health-hostname">â€”</span></div>
          <div class="health-kv"><span>OS</span><span id="health-os">â€”</span></div>
          <div class="health-kv"><span>Uptime</span><span id="health-uptime">â€”</span></div>
          <div class="health-kv"><span>IP</span><span id="health-ip">â€”</span></div>
          <div class="health-kv"><span>Battery</span><span id="health-battery">â€”</span></div>
          <div class="health-note" id="health-sys-note"></div>
        </div>
      </div>

      <div class="health-error hidden" id="health-error"></div>
    </section>
  </div>

  <footer class="footer">
    <div class="inner">â€”â€” Health â€”â€”<br>â€” Wadboard â€”</div>
  </footer>
</div>

<!-- Add/Edit modal -->
<div class="overlay hidden" id="overlay">
  <div class="modal">
    <div class="modal-top">
      <div class="tabs">
        <button class="tab" id="tab-service">Service</button>
        <button class="tab" id="tab-link">Link</button>
        <button class="tab" id="tab-wol">WOL</button>
        <button class="tab" id="tab-host">Device Cmd</button>
      </div>
      <button class="close" id="modal-close">Close</button>
    </div>

    <div class="modal-body">

    <!-- SERVICE FORM -->
    <form class="form" id="form-service">
      <h3 id="svc-form-title">Add Service</h3>

      <div class="field">
        <label class="label">Service Name</label>
        <input class="input" id="svc-name" placeholder="Server" required />
      </div>

      <div class="field">
        <label class="label">Open URL (UI URL)</label>
        <input class="input" id="svc-open" type="url" placeholder="http://service.local" required />
      </div>

      <div class="field">
        <label class="label">Status Check Method</label>
        <select class="input" id="svc-method">
          <option value="http">HTTP(S) request</option>
          <option value="ping">Ping host/IP</option>
        </select>
      </div>

      <div class="field">
        <label class="label" id="svc-check-label">Check URL (health probe)</label>
        <input class="input" id="svc-check" placeholder="http://service.local" required />
      </div>

      <div class="field">
        <label class="label">Notes</label>
        <textarea class="textarea" id="svc-notes" placeholder="Short notes"></textarea>
      </div>

      <button class="btn submit" type="submit" id="svc-submit">Create Service</button>
    </form>

    <!-- LINK FORM -->
    <form class="form hidden" id="form-link">
      <h3 id="lnk-form-title">Add Link</h3>
      <div class="field">
        <label class="label">Title</label>
        <input class="input" id="lnk-title" placeholder="Service" required />
      </div>
      <div class="field">
        <label class="label">URL</label>
        <input class="input" id="lnk-url" type="url" placeholder="http://service.local" required />
      </div>
      <div class="field">
        <label class="label">Icon (emoji or short text)</label>
        <input class="input" id="lnk-icon" placeholder="ðŸŽ«" />
      </div>
      <div class="field">
        <label class="label">Notes</label>
        <textarea class="textarea" id="lnk-notes" placeholder="Short notes"></textarea>
      </div>
      <button class="btn submit" type="submit" id="lnk-submit">Create Link</button>
    </form>

<!-- WOL FORM -->
<form class="form hidden" id="form-wol">
  <h3 id="wol-form-title">Add WOL</h3>

  <!-- WOL TYPE -->
  <div class="field">
    <label class="label">WOL Type</label>
    <select class="input" id="wol-type">
      <option value="basic">Basic (wol command)</option>
      <option value="mikrotik">MikroTik</option>
      <option value="wadesp">WadESP-PowerSW</option>
    </select>
  </div>

  <!-- COMMON -->
  <div class="field">
    <label class="label">Name</label>
    <input class="input" id="wol-name" placeholder="Wake SERVER" required />
  </div>

  <!-- BASIC WOL -->
  <div id="wol-basic">
    <div class="field">
      <label class="label">MAC address</label>
      <input class="input" id="wol-mac" placeholder="AA:BB:CC:DD:EE:FF">
    </div>

    <div class="field">
      <label class="label">Broadcast IP</label>
      <input class="input" id="wol-broadcast" placeholder="192.168.1.255">
    </div>

    <div class="field">
      <label class="label">UDP port</label>
      <input class="input" id="wol-port" placeholder="9">
    </div>

    <div class="field">
      <label class="label">SecureON password (optional)</label>
      <input class="input" id="wol-secureon" placeholder="AA-BB-CC-DD-EE-FF">
    </div>
  </div>

  <!-- MIKROTIK (AS IS) -->
  <div id="wol-mikrotik" class="hidden">
    <div class="field">
      <label class="label">MikroTik Host/IP</label>
      <input class="input" id="wol-host" placeholder="192.168.101.1" />
    </div>

    <div class="field">
      <label class="label">MikroTik User</label>
      <input class="input" id="wol-user" placeholder="admin" />
    </div>

    <div class="field">
      <label class="label">MikroTik Password</label>
      <input class="input" id="wol-pass" type="password" placeholder="********" />
    </div>

    <div class="field">
      <label class="label">MikroTik Script ID</label>
      <input class="input" id="wol-script" placeholder="1" />
    </div>
  </div>

  <!-- WADESP -->
<div id="wol-wadesp" class="hidden">
  <div class="field">
    <label class="label">ESP Host / IP</label>
    <input class="input" id="wol-esp-host" placeholder="192.168.1.50">
  </div>

  <div style="font-size:.75rem;color:var(--text-dim)">
    HTTP POST â†’ /power/on
  </div>
</div>


  <!-- NOTES -->
  <div class="field">
    <label class="label">Notes</label>
    <textarea class="textarea" id="wol-notes"></textarea>
  </div>

  <!-- SSH ACTIONS (ONLY FOR MIKROTIK, Ð»Ð¾Ð³Ð¸ÐºÐ° Ð½Ðµ Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼) -->
  <div class="field" id="wol-ssh-section">
    <label class="label">SSH Actions (optional)</label>
    <div class="ssh-section">
      <div id="wol-ssh-list"></div>
      <button class="btn" type="button" id="wol-ssh-add">+ Add SSH Action</button>
    </div>
  </div>

  <button class="btn submit" type="submit" id="wol-submit">Create WOL</button>
</form>


    <!-- HOST ACTION FORM -->
    <form class="form hidden" id="form-host">
      <h3 id="host-form-title">Add Device Command</h3>

      <div class="field">
        <label class="label">Button label</label>
        <input class="input" id="host-label" placeholder="Shutdown Termux host" required />
      </div>

      <div class="field">
        <label class="label">Command (executed on Termux host)</label>
        <textarea class="textarea" id="host-command" placeholder="sudo reboot"></textarea>
      </div>

      <div class="field">
        <label class="label">Notes</label>
        <textarea class="textarea" id="host-notes" placeholder="Short description"></textarea>
      </div>

      <button class="btn submit" type="submit" id="host-submit">Create Command</button>
    </form>
  </div>
</div>
</div>

<!-- Admin password modal (one-shot protected actions) -->
<div class="overlay hidden" id="admin-overlay">
  <div class="modal">
    <div class="modal-top">
      <div style="font-weight:800; font-size:.9rem; color:var(--text-main);">
        Admin login
      </div>
      <button class="close" id="admin-close">Close</button>
    </div>

    <form class="form" id="admin-form">
      <div class="field">
        <label class="label">Password</label>
        <input class="input" id="admin-pass" type="password" placeholder="********" required />
      </div>
      <button class="btn submit" type="submit" id="admin-submit">Unlock</button>
      <div id="admin-status" class="inline-status"></div>
    </form>
  </div>
</div>

<!-- Settings modal (edit mode + battery monitoring) -->
<div class="overlay hidden" id="settings-overlay">
  <div class="modal">
    <div class="modal-top">
      <div style="font-weight:800; font-size:.9rem; color:var(--text-main);">
        Settings
      </div>
      <button class="close" id="settings-close">Close</button>
    </div>

<div class="modal-body">

    <div class="form">
      <h3 style="margin-top:0;">Admin session</h3>
      <p id="settings-session-text" style="margin:0 0 .75rem; font-size:.8rem; color:var(--text-dim);"></p>

      <form id="settings-login-form" class="field" style="margin-bottom:.75rem;">
        <label class="label">Admin password</label>
        <input class="input" id="settings-pass" type="password" placeholder="********" required />
        <button class="btn submit" type="submit" style="margin-top:.6rem;">Unlock editing</button>
        <div id="settings-login-status" class="inline-status"></div>
      </form>

      <div id="settings-logout-row" class="field hidden" style="margin-top:.25rem;">
        <button class="btn btn-danger" type="button" id="settings-logout-btn">Log out</button>
      </div>
    </div>


<div id="settings-admin-only" class="hidden">
<div class="form" style="margin-top:1rem;">
  <h3 style="margin-top:0;">Change admin password</h3>

  <div class="field">
    <label class="label">Current password</label>
    <input class="input" id="pwd-old" type="password" placeholder="********">
  </div>

  <div class="field">
    <label class="label">New password</label>
    <input class="input" id="pwd-new" type="password" placeholder="Min 6 characters">
  </div>

  <button class="btn submit" type="button" id="pwd-save-btn">
    Change password
  </button>

  <div id="pwd-save-status"
       style="margin-top:.5rem;font-size:.75rem;color:var(--text-dim)">
  </div>
</div>


<div class="form" style="margin-top:1rem;">
  <h3 style="margin-top:0;">Brand mark</h3>

  <div class="field">
    <label class="label">Brand text (max 40, default WELCOME)</label>
    <input class="input" id="brand-text" placeholder="WELCOME" maxlength="40" />
  </div>

  <button class="btn submit" type="button" id="brand-save-btn">Save brand text</button>
  <div id="brand-save-status" style="margin-top:.5rem;font-size:.75rem;color:var(--text-dim)"></div>
</div>


    <div class="form" style="margin-top:1rem;">
      <h3 style="margin-top:0; display:flex; justify-content:space-between; align-items:center; gap:.5rem;">
        <span>Battery monitoring</span>
        <label style="display:flex; align-items:center; gap:.4rem; font-size:.8rem; color:var(--text-mid);">
          <input type="checkbox" id="battery-enabled" />
          <span>Enabled</span>
        </label>
      </h3>
      <p style="margin:0 0 .75rem; font-size:.76rem; color:var(--text-dim);">
        Only for Termux host with <b>termux-api</b> installed. Alerts are sent when battery percentage
        drops below configured levels.
      </p>

      <div class="field">
        <label class="label">Alert levels (%)</label>
        <input class="input" id="battery-levels" placeholder="30,15,5" />
        <div style="font-size:.75rem; color:var(--text-dim);">
          Comma-separated list, highest to lowest. Example: 30,15,5
        </div>
      </div>

      <div class="field">
        <label class="label">Telegram bot token</label>
        <input class="input" id="battery-bot-token" placeholder="123456:ABC-DEF..." />
      </div>

      <div class="field">
        <label class="label">Telegram chat ID</label>
        <input class="input" id="battery-chat-id" placeholder="@channel or numeric chat id" />
      </div>

      <button class="btn submit" type="button" id="battery-save-btn">Save battery settings</button>
      <div id="battery-save-status" style="margin-top:.5rem; font-size:.75rem; color:var(--text-dim);"></div>
    </div>
  </div>
</div>
</div>
</div>

<!-- Action results / error notifications -->
<div id="toast-stack" class="toast-stack"></div>

<script>
  // ==============================
  // CONFIG
  // ==============================
  const API_BASE = "/api";
  const THEME_KEY = "wadphTheme";

  let editMode = false;
  let state = { services: [], links: [], wol: [], hostActions: [] };

  // modal mode for Add/Edit forms
  let mode = { type: "service", action: "create", id: null };

  // pending protected action to execute after password check (one-shot)
  let pendingAction = null;

  // ==============================
  // DOM refs
  // ==============================
  const overlay = document.getElementById("overlay");
  const openBtn = document.getElementById("open-modal");
  const closeBtn = document.getElementById("modal-close");

  const tabSvcBtn  = document.getElementById("tab-service");
  const tabLnkBtn  = document.getElementById("tab-link");
  const tabWolBtn  = document.getElementById("tab-wol");
  const tabHostBtn = document.getElementById("tab-host");

  const formSvc  = document.getElementById("form-service");
  const formLnk  = document.getElementById("form-link");
  const formWol  = document.getElementById("form-wol");
  const formHost = document.getElementById("form-host");

  const svcTitleEl   = document.getElementById("svc-form-title");
  const svcSubmitEl  = document.getElementById("svc-submit");
  const lnkTitleEl   = document.getElementById("lnk-form-title");
  const lnkSubmitEl  = document.getElementById("lnk-submit");
  const wolTitleEl   = document.getElementById("wol-form-title");
  const wolSubmitEl  = document.getElementById("wol-submit");
  const hostTitleEl  = document.getElementById("host-form-title");
  const hostSubmitEl = document.getElementById("host-submit");

  const svcGrid = document.getElementById("svc-grid");
  const lnkGrid = document.getElementById("lnk-grid");
  const wolGrid = document.getElementById("wol-grid");

  const svcCount = document.getElementById("svc-count");
  const lnkCount = document.getElementById("lnk-count");
  const wolCount = document.getElementById("wol-count");

  const adminToggleBtn = document.getElementById("admin-toggle");
  const adminToggleHealthBtn = document.getElementById("admin-toggle-health");
  const adminOverlay   = document.getElementById("admin-overlay");
  const adminCloseBtn  = document.getElementById("admin-close");
  const adminForm      = document.getElementById("admin-form");
  const adminPassInput = document.getElementById("admin-pass");
  const adminStatusEl  = document.getElementById("admin-status");

  const svcMethodEl      = document.getElementById("svc-method");
  const svcCheckLabelEl  = document.getElementById("svc-check-label");
  const svcCheckInputEl  = document.getElementById("svc-check");

  const refreshBtn       = document.getElementById("refresh-btn");
  const healthBtn        = document.getElementById("health-btn");

  const homePage         = document.getElementById("home-page");
  const healthPage       = document.getElementById("health-page");
  const healthHomeBtn    = document.getElementById("health-home-btn");
  const healthRefreshBtn = document.getElementById("health-refresh-btn");
  const healthThemeBtn   = document.getElementById("theme-toggle-health");

  const healthUpdatedEl  = document.getElementById("health-updated");
  const healthErrorEl    = document.getElementById("health-error");

  const healthHostnameEl = document.getElementById("health-hostname");
  const healthOsEl       = document.getElementById("health-os");
  const healthUptimeEl   = document.getElementById("health-uptime");
  const healthIpEl       = document.getElementById("health-ip");
  const healthBatteryEl  = document.getElementById("health-battery");

  const healthCpuRingEl  = document.getElementById("health-cpu-ring");
  const healthCpuPctEl   = document.getElementById("health-cpu-pct");
  const healthCpuLoadEl  = document.getElementById("health-cpu-load");
  const healthCpuNoteEl  = document.getElementById("health-cpu-note");

  const healthRamBarEl   = document.getElementById("health-ram-bar");
  const healthRamTextEl  = document.getElementById("health-ram-text");
  const healthRamNoteEl  = document.getElementById("health-ram-note");

  const healthDiskBarEl  = document.getElementById("health-disk-bar");
  const healthDiskTextEl = document.getElementById("health-disk-text");
  const healthDiskNoteEl = document.getElementById("health-disk-note");

  const healthSysNoteEl  = document.getElementById("health-sys-note");

  const isHealthRoute = window.location.pathname === "/health";

  const wolHostInput     = document.getElementById("wol-host");
  const wolSshList       = document.getElementById("wol-ssh-list");
  const wolSshAddBtn     = document.getElementById("wol-ssh-add");

  const hostLabelInput   = document.getElementById("host-label");
  const hostCommandInput = document.getElementById("host-command");
  const hostNotesInput   = document.getElementById("host-notes");

  const settingsOverlay       = document.getElementById("settings-overlay");
  const settingsCloseBtn      = document.getElementById("settings-close");
  const settingsSessionText   = document.getElementById("settings-session-text");
  const settingsLoginForm     = document.getElementById("settings-login-form");
  const settingsPassInput     = document.getElementById("settings-pass");
  const settingsLoginStatusEl = document.getElementById("settings-login-status");
  const settingsLogoutRow     = document.getElementById("settings-logout-row");
  const settingsLogoutBtn     = document.getElementById("settings-logout-btn");

  const brandTextInput        = document.getElementById("brand-text");
  const brandSaveBtn          = document.getElementById("brand-save-btn");
  const brandSaveStatus       = document.getElementById("brand-save-status");

  const batteryEnabledInput   = document.getElementById("battery-enabled");
  const batteryLevelsInput    = document.getElementById("battery-levels");
  const batteryBotTokenInput  = document.getElementById("battery-bot-token");
  const batteryChatIdInput    = document.getElementById("battery-chat-id");
  const batterySaveBtn        = document.getElementById("battery-save-btn");
  const batterySaveStatus     = document.getElementById("battery-save-status");

  // ==============================
  // THEME
  // ==============================
  function loadTheme() {
    const t = localStorage.getItem(THEME_KEY);
    return t === "light" || t === "dark" ? t : "dark";
  }
  function applyTheme(t) {
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem(THEME_KEY, t);
  }
  applyTheme(loadTheme());

  function sanitizeBrandText(value) {
    const s = String(value == null ? "" : value);
    return s
      .replace(/[\r\n\t]+/g, " ")
      .replace(/[\u0000-\u001F\u007F]/g, "")
      .replace(/[<>]/g, "")
      .trim()
      .slice(0, 40);
  }

  let brandText = "WELCOME";
  let brandTextCustom = "";

  function applyBrandText() {
    document.querySelectorAll(".brand-mark").forEach(el => { el.textContent = brandText; });
  }

  function loadBrandTextIntoForm() {
    if (!brandTextInput) return;
    brandTextInput.value = brandTextCustom;
    if (brandSaveStatus) brandSaveStatus.textContent = "";
  }

  applyBrandText();

  async function refreshBrandTextFromServer() {
    const payload = await apiGET("/brand-text");
    if (payload && typeof payload.text === "string") {
      brandText = sanitizeBrandText(payload.text) || "WELCOME";
    } else {
      brandText = "WELCOME";
    }
    if (payload && typeof payload.custom === "string") {
      brandTextCustom = sanitizeBrandText(payload.custom);
    } else {
      brandTextCustom = "";
    }
    applyBrandText();
    loadBrandTextIntoForm();
  }

  function bindThemeToggle(btn) {
    if (!btn) return;
    btn.addEventListener("click", () => {
      const nextTheme =
        (document.documentElement.getAttribute("data-theme") === "dark")
        ? "light"
        : "dark";
      applyTheme(nextTheme);
    });
  }

  bindThemeToggle(document.getElementById("theme-toggle"));
  bindThemeToggle(healthThemeBtn);

  if (healthBtn) {
    healthBtn.addEventListener("click", () => {
      window.location.assign("/health");
    });
  }
  if (healthHomeBtn) {
    healthHomeBtn.addEventListener("click", () => {
      window.location.assign("/");
    });
  }

  // ==============================
  // UTIL
  // ==============================
  // Toast notifications for action results + errors (replaces browser alerts)
  const toastStack = document.getElementById("toast-stack");

  const ICON_BTN_EDIT = `<svg class="btn-icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/></svg><span class="sr-only">Edit</span>`;
  const ICON_BTN_DELETE = `<svg class="btn-icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/></svg><span class="sr-only">Delete</span>`;

  function showToast({ title, message, detail, type = "success", ttl = 5000 }) {
    if (!toastStack) return;
    const toast = document.createElement("div");
    toast.className = `toast ${type === "error" ? "toast-error" : "toast-success"}`;

    const t = document.createElement("div");
    t.className = "toast-title";
    t.textContent = title || (type === "error" ? "Error" : "Success");

    const b = document.createElement("div");
    b.className = "toast-body";
    b.textContent = message || "";

    toast.appendChild(t);
    toast.appendChild(b);

    if (detail) {
      const d = document.createElement("div");
      d.className = "toast-detail";
      d.textContent = detail;
      toast.appendChild(d);
    }

    toastStack.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, ttl);
  }

  function formatActionError(resp) {
    if (!resp) return { message: "Unknown error", detail: "" };
    if (resp.result && resp.result !== "error") {
      return { message: `Result: ${resp.result}`, detail: resp.detail || "" };
    }
    return { message: "Action failed", detail: resp.detail || resp.result || "" };
  }

  function fmt(ts) {
    if (!ts) return "never";
    const d = new Date(ts);
    const pad = n => String(n).padStart(2, "0");
    return (
      d.getFullYear() + "-" +
      pad(d.getMonth() + 1) + "-" +
      pad(d.getDate()) + " " +
      pad(d.getHours()) + ":" +
      pad(d.getMinutes()) + ":" +
      pad(d.getSeconds())
    );
  }

  async function apiGET(path) {
    const res = await fetch(API_BASE + path, {
      credentials: "include"
    });
    if (res.status === 401) {
      forceLogoutUI();
      return {};
    }
    return res.json().catch(() => ({}));
  }

  async function apiJSON(method, path, bodyObj) {
    const res = await fetch(API_BASE + path, {
      method,
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyObj)
    });
    if (res.status === 401) {
      forceLogoutUI();
      return {};
    }
    return res.json().catch(() => ({}));
  }

  async function apiDELETE(path) {
    const res = await fetch(API_BASE + path, {
      method: "DELETE",
      credentials: "include"
    });
    if (res.status === 401) {
      forceLogoutUI();
      return {};
    }
    return res.json().catch(() => ({}));
  }

  async function apiPOSTNoBody(path) {
    const res = await fetch(API_BASE + path, {
      method: "POST",
      credentials: "include"
    });
    if (res.status === 401) {
      forceLogoutUI();
      return {};
    }
    return res.json().catch(() => ({}));
  }

  // helper: ask for password only when needed for protected actions
  async function ensureAdminThen(actionFn) {
    if (editMode) {
      await actionFn();
      return;
    }
    pendingAction = actionFn;
    adminPassInput.value = "";
    if (adminStatusEl) {
      adminStatusEl.textContent = "";
      adminStatusEl.classList.remove("error", "success");
    }
    adminOverlay.classList.remove("hidden");
    adminPassInput.focus();
  }

  // ==============================
  // LOGIN / LOGOUT FLOW (one-shot actions)
  // ==============================
  if (adminToggleBtn) {
    adminToggleBtn.addEventListener("click", () => openSettingsModal());
  }
  if (adminToggleHealthBtn) {
    adminToggleHealthBtn.addEventListener("click", () => openSettingsModal());
  }

  adminCloseBtn.addEventListener("click", () => {
    pendingAction = null;
    adminOverlay.classList.add("hidden");
  });

  adminForm.addEventListener("submit", async e => {
    e.preventDefault();
    const pw = adminPassInput.value;

    if (adminStatusEl) {
      adminStatusEl.textContent = "";
      adminStatusEl.classList.remove("error", "success");
    }

    const res = await fetch(API_BASE + "/login", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pw })
    });

    if (res.status === 200) {
      const isQuickAction = !!pendingAction;

      // For one-shot WOL/SSH/host actions: execute and stay in normal mode
      if (isQuickAction && pendingAction) {
        adminOverlay.classList.add("hidden");
        const fn = pendingAction;
        pendingAction = null;

        await loadStateFromServer();
        await fn();
      } else {
        // Fallback: if called without pendingAction, do not enable editMode here
        adminOverlay.classList.add("hidden");
      }
    } else {
      const payload = await res.json().catch(() => ({}));
      const err = payload && payload.error ? payload.error : "bad_password";
      if (adminStatusEl) {
        adminStatusEl.textContent =
          err === "password_too_short"
            ? "Password too short (min 6 characters)."
            : "Wrong admin password.";
        adminStatusEl.classList.add("error");
      }
      adminPassInput.value = "";
      adminPassInput.focus();
    }
  });

  async function logoutRequest() {
    await fetch(API_BASE + "/logout", {
      method: "POST",
      credentials: "include"
    });
  }


function syncSettingsUI() {
  const adminOnlyBox = document.getElementById("settings-admin-only");

  if (editMode) {
    settingsSessionText.textContent =
      "Edit mode is enabled for this browser session.";
    settingsLoginForm.classList.add("hidden");
    settingsLogoutRow.classList.remove("hidden");
    adminOnlyBox.classList.remove("hidden");
  } else {
    settingsSessionText.textContent =
      "Enter admin password to enable editing and configure additional features.";
    settingsLoginForm.classList.remove("hidden");
    settingsLogoutRow.classList.add("hidden");
    adminOnlyBox.classList.add("hidden");
  }
}



  function forceLogoutUI() {
    editMode = false;
    pendingAction = null;
    openBtn.classList.add("hidden");
    render();
  }

  // ==============================
  // SETTINGS MODAL (edit mode + battery alerts)
  // ==============================
 
async function changeAdminPassword(oldPw, newPw) {
  const res = await apiJSON("PUT", "/admin/password", {
    oldPassword: oldPw,
    newPassword: newPw
  });

  if (res && res.ok) {
    showToast({ title: "Admin Password", message: "Password changed", type: "success" });
  } else {
    showToast({ title: "Admin Password", message: "Password change failed", type: "error" });
  }
}



 async function loadBatteryConfigIntoForm() {
    if (!batteryEnabledInput) return;
    const cfg = await apiGET("/battery-alerts");
    if (!cfg) return;

    batteryEnabledInput.checked = !!cfg.enabled;
    if (Array.isArray(cfg.levels) && cfg.levels.length) {
      batteryLevelsInput.value = cfg.levels.join(",");
    } else {
      batteryLevelsInput.value = "30,15,5";
    }
    batteryBotTokenInput.value = cfg.telegramBotToken || "";
    batteryChatIdInput.value = cfg.telegramChatId || "";
    batterySaveStatus.textContent = "";
  }

  function openSettingsModal() {
    if (!settingsOverlay) return;
    settingsOverlay.classList.remove("hidden");
    const adminOnlyBox = document.getElementById("settings-admin-only");

    if (editMode) {
      settingsSessionText.textContent = "Edit mode is enabled for this browser session.";
      settingsLoginForm.classList.add("hidden");
      settingsLogoutRow.classList.remove("hidden");
      adminOnlyBox.classList.remove("hidden");
      loadBrandTextIntoForm();
      loadBatteryConfigIntoForm();
    } else {
      settingsSessionText.textContent = "Enter admin password to enable editing and configure additional features.";
      settingsLoginForm.classList.remove("hidden");
      settingsLogoutRow.classList.add("hidden");
      settingsPassInput.value = "";
      settingsPassInput.focus();
      if (settingsLoginStatusEl) {
        settingsLoginStatusEl.textContent = "";
        settingsLoginStatusEl.classList.remove("error", "success");
      }
      adminOnlyBox.classList.add("hidden");
    }
  }

  function closeSettingsModal() {
    if (!settingsOverlay) return;
    settingsOverlay.classList.add("hidden");
  }

  settingsCloseBtn.addEventListener("click", closeSettingsModal);

  settingsLoginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const pw = settingsPassInput.value;
    if (!pw) return;

    if (settingsLoginStatusEl) {
      settingsLoginStatusEl.textContent = "";
      settingsLoginStatusEl.classList.remove("error", "success");
    }

    const res = await fetch(API_BASE + "/login", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pw })
    });

    if (res.status === 200) {
      editMode = true;
      openBtn.classList.remove("hidden");

      settingsSessionText.textContent = "Edit mode is enabled for this browser session.";
      settingsLoginForm.classList.add("hidden");
      settingsLogoutRow.classList.remove("hidden");

      syncSettingsUI();

      await loadStateFromServer();
      // updateBatteryFormDisabled();
      await loadBatteryConfigIntoForm();
    } else {
      const payload = await res.json().catch(() => ({}));
      const err = payload && payload.error ? payload.error : "bad_password";
      if (settingsLoginStatusEl) {
        settingsLoginStatusEl.textContent =
          err === "password_too_short"
            ? "Password too short (min 6 characters)."
            : "Wrong admin password.";
        settingsLoginStatusEl.classList.add("error");
      }
      settingsPassInput.value = "";
      settingsPassInput.focus();
    }
  });

  settingsLogoutBtn.addEventListener("click", async () => {
     await logoutRequest();
     editMode = false;
     forceLogoutUI();
     syncSettingsUI();   
  });

batterySaveBtn.addEventListener("click", async () => {
  if (!editMode) return;

    const enabled = !!batteryEnabledInput.checked;
    const rawLevels = batteryLevelsInput.value || "";
    const levels = rawLevels
      .split(/[,\s]+/)
      .map(x => parseInt(x, 10))
      .filter(n => Number.isFinite(n) && n > 0 && n <= 100);

    const body = {
      enabled,
      levels: levels.length ? levels : undefined,
      telegramBotToken: batteryBotTokenInput.value.trim(),
      telegramChatId: batteryChatIdInput.value.trim()
    };

    batterySaveStatus.textContent = "Saving...";
    const resp = await apiJSON("PUT", "/battery-alerts", body);
    if (resp && resp.ok) {
      batterySaveStatus.textContent = "Saved.";
    } else {
      batterySaveStatus.textContent = "Error saving settings.";
    }
  });

  // ==============================
  // SERVER SYNC
  // ==============================
  async function loadStateFromServer() {
    const data = await apiGET("/state");
    state = {
      services: data.services || [],
      links: data.links || [],
      wol: data.wol || [],
      hostActions: data.hostActions || []
    };
    render();
  }

  async function persistOrderServices() {
    const order = state.services.map(s => s.id);
    await apiJSON("PUT", "/reorder/services", { order });
  }

  async function persistOrderLinks() {
    const order = state.links.map(l => l.id);
    await apiJSON("PUT", "/reorder/links", { order });
  }

  async function persistOrderWOL() {
    const order = state.wol.map(w => w.id);
    await apiJSON("PUT", "/reorder/wol", { order });
  }

  // ==============================
  // MODAL / FORMS
  // ==============================
  function updateSvcCheckLabel() {
    if (svcMethodEl.value === "ping") {
      svcCheckLabelEl.textContent = "Host/IP to ping";
      svcCheckInputEl.placeholder = "192.168.100.10";
    } else {
      svcCheckLabelEl.textContent = "Check URL (health probe)";
      svcCheckInputEl.placeholder = "http://service.local";
    }
  }
  svcMethodEl.addEventListener("change", updateSvcCheckLabel);

  function resetServiceForm() {
    document.getElementById("svc-name").value     = "";
    document.getElementById("svc-open").value     = "";
    svcMethodEl.value                             = "http";
    document.getElementById("svc-check").value    = "";
    document.getElementById("svc-notes").value    = "";
    updateSvcCheckLabel();
  }

  function resetLinkForm() {
    document.getElementById("lnk-title").value = "";
    document.getElementById("lnk-url").value   = "";
    document.getElementById("lnk-icon").value  = "";
    document.getElementById("lnk-notes").value = "";
  }

  function clearWolSshForm() {
    wolSshList.innerHTML = "";
  }

  function resetWolForm() {
    const typeEl = document.getElementById("wol-type");
    if (typeEl) typeEl.value = "basic";
    document.getElementById("wol-name").value   = "";
    document.getElementById("wol-host").value   = "";
    document.getElementById("wol-user").value   = "";
    document.getElementById("wol-pass").value   = "";
    document.getElementById("wol-script").value = "";
    document.getElementById("wol-notes").value  = "";
    document.getElementById("wol-mac").value       = "";
    document.getElementById("wol-broadcast").value = "";
    document.getElementById("wol-port").value      = "";
    document.getElementById("wol-secureon").value  = "";
    document.getElementById("wol-esp-host").value  = "";
    const tokEl = document.getElementById("wol-esp-token");
    if (tokEl) tokEl.value = "";
    if (typeof updateWolTypeUI === "function") updateWolTypeUI();
    clearWolSshForm();
  }

  function resetHostForm() {
    hostLabelInput.value   = "";
    hostCommandInput.value = "";
    hostNotesInput.value   = "";
  }

  function updateFormTitles() {
    if (mode.type === "service") {
      if (mode.action === "create") {
        svcTitleEl.textContent  = "Add Service";
        svcSubmitEl.textContent = "Create Service";
      } else {
        svcTitleEl.textContent  = "Edit Service";
        svcSubmitEl.textContent = "Save Changes";
      }
    } else if (mode.type === "link") {
      if (mode.action === "create") {
        lnkTitleEl.textContent  = "Add Link";
        lnkSubmitEl.textContent = "Create Link";
      } else {
        lnkTitleEl.textContent  = "Edit Link";
        lnkSubmitEl.textContent = "Save Changes";
      }
    } else if (mode.type === "wol") {
      if (mode.action === "create") {
        wolTitleEl.textContent  = "Add WOL";
        wolSubmitEl.textContent = "Create WOL";
      } else {
        wolTitleEl.textContent  = "Edit WOL";
        wolSubmitEl.textContent = "Save Changes";
      }
    } else {
      if (mode.action === "create") {
        hostTitleEl.textContent  = "Add Device Command";
        hostSubmitEl.textContent = "Create Command";
      } else {
        hostTitleEl.textContent  = "Edit Device Command";
        hostSubmitEl.textContent = "Save Changes";
      }
    }
  }

  function showOnlyForm(which) {
    formSvc.classList.add("hidden");
    formLnk.classList.add("hidden");
    formWol.classList.add("hidden");
    formHost.classList.add("hidden");

    if (which === "service") formSvc.classList.remove("hidden");
    if (which === "link")    formLnk.classList.remove("hidden");
    if (which === "wol")     formWol.classList.remove("hidden");
    if (which === "host")    formHost.classList.remove("hidden");
  }

  function createWolSshRow(action) {
    const row = document.createElement("div");
    row.className = "ssh-row";

    // SSH action inputs (label/user/host/pass/command)
    const labelInput = document.createElement("input");
    labelInput.className = "input ssh-input";
    labelInput.placeholder = "Button label (e.g. Shutdown PC)";
    labelInput.value = action.label || "";
    labelInput.dataset.field = "label";

    const userInput = document.createElement("input");
    userInput.className = "input ssh-input";
    userInput.placeholder = "SSH user";
    userInput.value = action.user || "";
    userInput.dataset.field = "user";

    const hostInput = document.createElement("input");
    hostInput.className = "input ssh-input";
    hostInput.placeholder = "SSH host (default: MikroTik Host/IP)";
    hostInput.value = action.host || wolHostInput.value.trim();
    hostInput.dataset.field = "host";

    const passInput = document.createElement("input");
    passInput.className = "input ssh-input";
    passInput.type = "password";
    passInput.placeholder = "SSH password (optional)";
    passInput.value = action.pass || "";
    passInput.dataset.field = "pass";

    const cmdInput = document.createElement("input");
    cmdInput.className = "input ssh-input";
    cmdInput.placeholder = "SSH command (e.g. sudo systemctl poweroff)";
    cmdInput.value = action.command || "";
    cmdInput.dataset.field = "command";

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "btn btn-danger";
    removeBtn.textContent = "Remove";
    removeBtn.onclick = () => row.remove();

    row.appendChild(labelInput);
    row.appendChild(userInput);
    row.appendChild(hostInput);
    row.appendChild(passInput);
    row.appendChild(cmdInput);
    row.appendChild(removeBtn);

    return row;
  }

  wolSshAddBtn.addEventListener("click", () => {
    const row = createWolSshRow({ host: wolHostInput.value.trim() });
    wolSshList.appendChild(row);
  });

  function collectWolSshActions() {
    const actions = [];
    const rows = wolSshList.querySelectorAll(".ssh-row");
    rows.forEach(row => {
      const label = row.querySelector("input[data-field='label']").value.trim();
      const user  = row.querySelector("input[data-field='user']").value.trim();
      const host  = row.querySelector("input[data-field='host']").value.trim();
      const pass  = row.querySelector("input[data-field='pass']").value;
      const cmd   = row.querySelector("input[data-field='command']").value.trim();
      if (!label || !user || !cmd) return;
      actions.push({
        label,
        user,
        host,
        pass,
        command: cmd
      });
    });
    return actions;
  }

  function showModal(whichType, editId = null) {
    if (!editMode) return;

    mode.type   = whichType;
    mode.id     = editId;
    mode.action = editId ? "edit" : "create";

    overlay.classList.remove("hidden");

    if (whichType === "service") {
      showOnlyForm("service");
      if (mode.action === "edit") {
        const svc = state.services.find(s => s.id === mode.id);
        if (svc) {
          document.getElementById("svc-name").value     = svc.name || "";
          document.getElementById("svc-open").value     = svc.openUrl || "";
          svcMethodEl.value                             = svc.method || "http";
          document.getElementById("svc-check").value    = svc.checkUrl || "";
          document.getElementById("svc-notes").value    = svc.notes || "";
          updateSvcCheckLabel();
        }
      } else {
        resetServiceForm();
      }
    } else if (whichType === "link") {
      showOnlyForm("link");
      if (mode.action === "edit") {
        const lnk = state.links.find(l => l.id === mode.id);
        if (lnk) {
          document.getElementById("lnk-title").value = lnk.title || "";
          document.getElementById("lnk-url").value   = lnk.url   || "";
          document.getElementById("lnk-icon").value  = lnk.icon  || "";
          document.getElementById("lnk-notes").value = lnk.notes || "";
        }
      } else {
        resetLinkForm();
      }
    } else if (whichType === "wol") {
      showOnlyForm("wol");
      if (mode.action === "edit") {
        const task = state.wol.find(w => w.id === mode.id);
        if (task) {
          const typeEl = document.getElementById("wol-type");
          if (typeEl) typeEl.value = task.type || "basic";
          document.getElementById("wol-name").value   = task.name     || "";
          document.getElementById("wol-host").value   = task.host     || "";
          document.getElementById("wol-user").value   = task.user     || "";
          document.getElementById("wol-pass").value   = task.pass     || "";
          document.getElementById("wol-script").value = task.scriptId || "";
          document.getElementById("wol-notes").value  = task.notes    || "";
          if (task.type === "wadesp") {
            document.getElementById("wol-esp-host").value  = task.espHost  || "";
            const tokEl = document.getElementById("wol-esp-token");
            if (tokEl) tokEl.value = task.espToken || "";
          }
          if (typeof updateWolTypeUI === "function") updateWolTypeUI();
          clearWolSshForm();
          if (Array.isArray(task.sshActions)) {
            task.sshActions.forEach(a => {
              const row = createWolSshRow(a);
              wolSshList.appendChild(row);
            });
          }
        }
      } else {
        resetWolForm();
      }
    } else if (whichType === "host") {
      showOnlyForm("host");
      if (mode.action === "edit") {
        const action = state.hostActions.find(a => a.id === mode.id);
        if (action) {
          hostLabelInput.value   = action.label || "";
          hostCommandInput.value = action.command || "";
          hostNotesInput.value   = action.notes || "";
        }
      } else {
        resetHostForm();
      }
    }

    updateFormTitles();
  }

  function hideModal() {
    overlay.classList.add("hidden");
  }

  openBtn.addEventListener("click", () => showModal("service"));
  closeBtn.addEventListener("click", hideModal);

  tabSvcBtn.addEventListener("click", () => showModal("service", mode.action === "edit" ? mode.id : null));
  tabLnkBtn.addEventListener("click", () => showModal("link",    mode.action === "edit" ? mode.id : null));
  tabWolBtn.addEventListener("click", () => showModal("wol",     mode.action === "edit" ? mode.id : null));
  tabHostBtn.addEventListener("click", () => showModal("host",   mode.action === "edit" ? mode.id : null));

  // ==============================
  // FORM SUBMIT HANDLERS (CRUD)
  // ==============================
  formSvc.addEventListener("submit", async e => {
    e.preventDefault();
    if (!editMode) return;

    const body = {
      name:     document.getElementById("svc-name").value.trim(),
      openUrl:  document.getElementById("svc-open").value.trim(),
      method:   svcMethodEl.value,
      checkUrl: document.getElementById("svc-check").value.trim(),
      notes:    document.getElementById("svc-notes").value.trim()
    };
    if (!body.name || !body.openUrl || !body.checkUrl) return;

    if (mode.action === "edit" && mode.id) {
      await apiJSON("PUT", "/service/" + mode.id, body);
    } else {
      await apiJSON("POST", "/service", body);
    }

    hideModal();
    await loadStateFromServer();
  });

  formLnk.addEventListener("submit", async e => {
    e.preventDefault();
    if (!editMode) return;

    const body = {
      title: document.getElementById("lnk-title").value.trim(),
      url:   document.getElementById("lnk-url").value.trim(),
      icon:  document.getElementById("lnk-icon").value.trim(),
      notes: document.getElementById("lnk-notes").value.trim()
    };
    if (!body.title || !body.url) return;

    if (mode.action === "edit" && mode.id) {
      await apiJSON("PUT", "/link/" + mode.id, body);
    } else {
      await apiJSON("POST", "/link", body);
    }

    hideModal();
    await loadStateFromServer();
  });


formWol.addEventListener("submit", async e => {
  e.preventDefault();
  if (!editMode) return;

  const type = document.getElementById("wol-type").value;

  let body = {
    name: document.getElementById("wol-name").value.trim(),
    type,
    notes: document.getElementById("wol-notes").value.trim(),
    sshActions: collectWolSshActions()
  };

  if (type === "basic") {
    body.mac       = document.getElementById("wol-mac").value.trim();
    body.broadcast = document.getElementById("wol-broadcast").value.trim();
    body.port      = document.getElementById("wol-port").value.trim();
    body.secureon  = document.getElementById("wol-secureon").value.trim();
    if (!body.mac) return;
  }

  if (type === "mikrotik") {
    body.host     = document.getElementById("wol-host").value.trim();
    body.user     = document.getElementById("wol-user").value.trim();
    body.pass     = document.getElementById("wol-pass").value.trim();
    body.scriptId = document.getElementById("wol-script").value.trim();
    if (!body.host || !body.user || !body.pass || !body.scriptId) return;
  }

  if (type === "wadesp") {
    body.espHost = document.getElementById("wol-esp-host").value.trim();
    if (!body.espHost) return;
  }

  if (mode.action === "edit" && mode.id) {
    await apiJSON("PUT", "/wol/" + mode.id, body);
  } else {
    await apiJSON("POST", "/wol", body);
  }

  hideModal();
  await loadStateFromServer();
});

if (brandSaveBtn) {
  brandSaveBtn.addEventListener("click", async () => {
    if (!editMode) return;
    const cleaned = sanitizeBrandText(brandTextInput ? brandTextInput.value : "");
    try {
      brandSaveBtn.disabled = true;
      if (brandSaveStatus) brandSaveStatus.textContent = "Saving...";

      const resp = await apiJSON("PUT", "/brand-text", { text: cleaned });
      if (resp && resp.ok) {
        brandText = sanitizeBrandText(resp.text) || "WELCOME";
        brandTextCustom = sanitizeBrandText(resp.custom || "");
        applyBrandText();
        loadBrandTextIntoForm();
        if (brandSaveStatus) brandSaveStatus.textContent = "Saved";
      } else {
        if (brandSaveStatus) brandSaveStatus.textContent = "Save failed";
      }
    } catch (e) {
      if (brandSaveStatus) brandSaveStatus.textContent = "Save failed";
    } finally {
      brandSaveBtn.disabled = false;
    }
  });
}



  formHost.addEventListener("submit", async e => {
    e.preventDefault();
    if (!editMode) return;

    const body = {
      label:   hostLabelInput.value.trim(),
      command: hostCommandInput.value.trim(),
      notes:   hostNotesInput.value.trim()
    };
    if (!body.label || !body.command) return;

    if (mode.action === "edit" && mode.id) {
      await apiJSON("PUT", "/host-action/" + mode.id, body);
    } else {
      await apiJSON("POST", "/host-action", body);
    }

    hideModal();
    await loadStateFromServer();
  });

  // ==============================
  // DELETE HANDLERS (with confirm)
  // ==============================
  async function deleteService(id) {
    if (!editMode) return;
    const svc = state.services.find(s => s.id === id);
    const name = svc ? svc.name : id;
    const ok = window.confirm(`Delete service "${name}"? This cannot be undone.`);
    if (!ok) return;
    await apiDELETE("/service/" + id);
    await loadStateFromServer();
  }

  async function deleteLink(id) {
    if (!editMode) return;
    const lnk = state.links.find(l => l.id === id);
    const name = lnk ? lnk.title : id;
    const ok = window.confirm(`Delete link "${name}"? This cannot be undone.`);
    if (!ok) return;
    await apiDELETE("/link/" + id);
    await loadStateFromServer();
  }

  async function deleteWol(id) {
    if (!editMode) return;
    const task = state.wol.find(w => w.id === id);
    const name = task ? task.name : id;
    const ok = window.confirm(`Delete WOL task "${name}"? This cannot be undone.`);
    if (!ok) return;
    await apiDELETE("/wol/" + id);
    await loadStateFromServer();
  }

  async function deleteHostAction(id) {
    if (!editMode) return;
    const action = state.hostActions.find(a => a.id === id);
    const name = action ? action.label : id;
    const ok = window.confirm(`Delete device command "${name}"? This cannot be undone.`);
    if (!ok) return;
    await apiDELETE("/host-action/" + id);
    await loadStateFromServer();
  }

  // ==============================
  // WOL RUN / SSH RUN / HOST RUN
  // ==============================
  async function runWol(id) {
    const resp = await apiPOSTNoBody("/wol/" + id + "/run");
    if (resp && resp.ok) {
      showToast({ title: "WOL", message: "Executed successfully", type: "success" });
    } else {
      const err = formatActionError(resp);
      showToast({ title: "WOL", message: err.message, detail: err.detail, type: "error" });
    }
    await loadStateFromServer();
  }

  async function runWolSsh(wolId, actionId) {
    const resp = await apiPOSTNoBody(`/wol/${wolId}/ssh/${actionId}/run`);
    if (resp && resp.ok) {
      showToast({ title: "SSH Action", message: "Executed successfully", type: "success" });
    } else {
      const err = formatActionError(resp);
      showToast({ title: "SSH Action", message: err.message, detail: err.detail, type: "error" });
    }
    await loadStateFromServer();
  }

  async function runHostAction(id) {
    const resp = await apiPOSTNoBody(`/host-action/${id}/run`);
    if (resp && resp.ok) {
      showToast({ title: "Device Command", message: "Executed successfully", type: "success" });
    } else {
      const err = formatActionError(resp);
      showToast({ title: "Device Command", message: err.message, detail: err.detail, type: "error" });
    }
    await loadStateFromServer();
  }

  // ==============================
  // DRAG & DROP (reorder)
  // ==============================
  let dragSvcIdx = null;
  let dragLnkIdx = null;
  let dragWolIdx = null;

  function bindDrag(containerId, type, arr, persistFn) {
    const cont  = document.getElementById(containerId);
    const cards = Array.from(cont.querySelectorAll(`.card[data-type='${type}']`));

    cards.forEach((card, idx) => {
      if (editMode) {
        card.setAttribute("draggable", "true");
      } else {
        card.removeAttribute("draggable");
      }

      card.dataset.index = idx;

      card.addEventListener("dragstart", e => {
        if (!editMode) return;
        if (type === "service")      dragSvcIdx = idx;
        else if (type === "link")    dragLnkIdx = idx;
        else                         dragWolIdx = idx;
        e.dataTransfer.effectAllowed = "move";
      });

      card.addEventListener("dragover", e => {
        if (!editMode) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        card.classList.add("drag-over");
      });

      card.addEventListener("dragleave", () => {
        card.classList.remove("drag-over");
      });

      card.addEventListener("drop", async e => {
        if (!editMode) return;
        e.preventDefault();
        card.classList.remove("drag-over");

        const from = (type === "service") ? dragSvcIdx
                    : (type === "link")   ? dragLnkIdx
                    : dragWolIdx;
        const to = Number(card.dataset.index);

        if (Number.isInteger(from) && from !== to) {
          const moved = arr.splice(from, 1)[0];
          arr.splice(to, 0, moved);

          await persistFn();
          await loadStateFromServer();
        }

        if (type === "service")      dragSvcIdx = null;
        else if (type === "link")    dragLnkIdx = null;
        else                         dragWolIdx = null;
      });
    });
  }

  // ==============================
  // RENDER
  // ==============================
  function render() {
    svcCount.textContent = state.services.length + " total";
    lnkCount.textContent = state.links.length + " total";
    wolCount.textContent = state.wol.length + " total";

    // services grid
    svcGrid.innerHTML = state.services.length
      ? ""
      : `<div style="color:var(--text-dim); font-size:.85rem;">No services yet</div>`;

    state.services.forEach(s => {
      const card = renderServiceCard(s);
      svcGrid.appendChild(card);
    });
    if (state.services.length % 2 === 1 && state.services.length > 0) {
      const lastCard = svcGrid.lastElementChild;
      if (lastCard) lastCard.classList.add("full-span");
    }

    // links grid
    lnkGrid.innerHTML = state.links.length
      ? ""
      : `<div style="color:var(--text-dim); font-size:.85rem;">No links yet</div>`;

    state.links.forEach(l => {
      const card = renderLinkCard(l);
      lnkGrid.appendChild(card);
    });
    if (state.links.length % 2 === 1 && state.links.length > 0) {
      const lastCard = lnkGrid.lastElementChild;
      if (lastCard) lastCard.classList.add("full-span");
    }

    // wol grid
    wolGrid.innerHTML = state.wol.length
      ? ""
      : `<div style="color:var(--text-dim); font-size:.85rem;">No WOL yet</div>`;

    state.wol.forEach(w => {
      const card = renderWolCard(w);
      wolGrid.appendChild(card);
    });
    if (state.wol.length % 2 === 1 && state.wol.length > 0) {
      const lastCard = wolGrid.lastElementChild;
      if (lastCard) lastCard.classList.add("full-span");
    }

    // host actions in banner
    renderHostActions();

    bindDrag("svc-grid", "service", state.services, persistOrderServices);
    bindDrag("lnk-grid", "link", state.links, persistOrderLinks);
    bindDrag("wol-grid", "wol", state.wol, persistOrderWOL);
  }

  function renderServiceCard(s) {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.type = "service";

    const top = document.createElement("div");
    top.className = "svc-top";

    const left = document.createElement("div");

    const nameWrap = document.createElement("div");
    nameWrap.className = "svc-name";

    const spanName = document.createElement("span");
    spanName.textContent = s.name;

    const spanChip = document.createElement("span");
    spanChip.className = (s.lastStatus === "UP") ? "chip-up" : "chip-down";
    spanChip.textContent = s.lastStatus || "unknown";

    nameWrap.appendChild(spanName);
    nameWrap.appendChild(spanChip);

    const urlEl = document.createElement("div");
    urlEl.className = "svc-url";
    urlEl.textContent = s.openUrl;

    left.appendChild(nameWrap);
    left.appendChild(urlEl);

    if (s.notes) {
      const notesEl = document.createElement("div");
      notesEl.className = "svc-notes";
      notesEl.textContent = s.notes;
      left.appendChild(notesEl);
    }

    const right = document.createElement("div");
    right.className = "btn-row";

    const openBtn = document.createElement("a");
    openBtn.className = "btn";
    openBtn.textContent = "Open";
    openBtn.href = s.openUrl;
    openBtn.target = "_blank";
    openBtn.rel = "noopener";
    right.appendChild(openBtn);

    if (editMode) {
      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-icon-only";
      editBtn.innerHTML = ICON_BTN_EDIT;
      editBtn.setAttribute("aria-label", "Edit");
      editBtn.title = "Edit";
      editBtn.onclick = () => showModal("service", s.id);
      right.appendChild(editBtn);

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-danger btn-icon-only";
      delBtn.innerHTML = ICON_BTN_DELETE;
      delBtn.setAttribute("aria-label", "Delete");
      delBtn.title = "Delete";
      delBtn.onclick = () => deleteService(s.id);
      right.appendChild(delBtn);
    }

    top.appendChild(left);
    top.appendChild(right);

    const meta = document.createElement("div");
    meta.className = "meta";

    const g1 = document.createElement("div");
    g1.className = "group";
    g1.innerHTML = `<b>Last check</b>${fmt(s.lastChecked)}`;

    meta.appendChild(g1);

    card.appendChild(top);
    card.appendChild(meta);

    return card;
  }

  function renderLinkCard(l) {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.type = "link";

    const row = document.createElement("div");
    row.className = "link-row";

    const left = document.createElement("div");
    left.className = "link-left";

    const iconEl = document.createElement("div");
    iconEl.className = "link-icon";
    iconEl.textContent = l.icon || "ðŸ”—";

    const txtWrap = document.createElement("div");

    const titleEl = document.createElement("div");
    titleEl.className = "link-title";
    titleEl.textContent = l.title;

    const urlEl = document.createElement("div");
    urlEl.className = "link-url";
    urlEl.textContent = l.url;

    txtWrap.appendChild(titleEl);
    txtWrap.appendChild(urlEl);

    if (l.notes) {
      const notesEl = document.createElement("div");
      notesEl.className = "link-notes";
      notesEl.textContent = l.notes;
      txtWrap.appendChild(notesEl);
    }

    left.appendChild(iconEl);
    left.appendChild(txtWrap);

    const right = document.createElement("div");
    right.className = "btn-row";

    const openBtn = document.createElement("a");
    openBtn.className = "btn";
    openBtn.textContent = "Open";
    openBtn.href = l.url;
    openBtn.target = "_blank";
    openBtn.rel = "noopener";
    right.appendChild(openBtn);

    if (editMode) {
      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-icon-only";
      editBtn.innerHTML = ICON_BTN_EDIT;
      editBtn.setAttribute("aria-label", "Edit");
      editBtn.title = "Edit";
      editBtn.onclick = () => showModal("link", l.id);
      right.appendChild(editBtn);

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-danger btn-icon-only";
      delBtn.innerHTML = ICON_BTN_DELETE;
      delBtn.setAttribute("aria-label", "Delete");
      delBtn.title = "Delete";
      delBtn.onclick = () => deleteLink(l.id);
      right.appendChild(delBtn);
    }

    row.appendChild(left);
    row.appendChild(right);

    card.appendChild(row);
    return card;
  }

  function renderWolCard(w) {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.type = "wol";

    const row = document.createElement("div");
    row.className = "wol-row";

    const left = document.createElement("div");
    left.className = "wol-left";

    const titleEl = document.createElement("div");
    titleEl.className = "wol-title";
    titleEl.textContent = w.name;

    if (w.notes) {
      const notesEl = document.createElement("div");
      notesEl.className = "wol-notes";
      notesEl.textContent = w.notes;
      left.appendChild(notesEl);
    }

    const metaEl = document.createElement("div");
    metaEl.className = "wol-meta";
    const chip = `<span class="wol-chip">${w.lastResult || "never"}</span>`;
    metaEl.innerHTML = chip + "  Last run: " + fmt(w.lastRun);

    left.appendChild(titleEl);
    left.appendChild(metaEl);

    const right = document.createElement("div");
    right.className = "btn-row";

    // Run WOL always visible, password-protected when not in edit mode
    const runBtn = document.createElement("button");
    runBtn.className = "btn";
    runBtn.textContent = "Run";
    runBtn.onclick = () => ensureAdminThen(() => runWol(w.id));
    right.appendChild(runBtn);

    // SSH actions always visible, password-protected when not in edit mode
    if (Array.isArray(w.sshActions)) {
      w.sshActions.forEach(a => {
        const sshBtn = document.createElement("button");
        sshBtn.className = "btn";
        sshBtn.textContent = a.label || "SSH";
        sshBtn.onclick = () => ensureAdminThen(() => runWolSsh(w.id, a.id));
        right.appendChild(sshBtn);
      });
    }

    // Edit/delete only in edit mode
    if (editMode) {
      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-icon-only";
      editBtn.innerHTML = ICON_BTN_EDIT;
      editBtn.setAttribute("aria-label", "Edit");
      editBtn.title = "Edit";
      editBtn.onclick = () => showModal("wol", w.id);
      right.appendChild(editBtn);

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-danger btn-icon-only";
      delBtn.innerHTML = ICON_BTN_DELETE;
      delBtn.setAttribute("aria-label", "Delete");
      delBtn.title = "Delete";
      delBtn.onclick = () => deleteWol(w.id);
      right.appendChild(delBtn);
    }

    row.appendChild(left);
    row.appendChild(right);

    card.appendChild(row);
    return card;
  }

  function renderHostActions() {
    const container = document.getElementById("host-actions");
    if (!container) return;

    container.innerHTML = "";

    if (!state.hostActions || state.hostActions.length === 0) {
      const span = document.createElement("span");
      span.className = "host-actions-note";
      span.textContent = editMode
        ? "No maintenance commands yet"
        : "No maintenance commands available";
      container.appendChild(span);

      if (editMode) {
        const addBtn = document.createElement("button");
        addBtn.className = "btn";
        addBtn.textContent = "+ Add Cmd";
        addBtn.style.marginLeft = "0.5rem";
        addBtn.onclick = () => {
          mode.action = "create";
          mode.id = null;
          showModal("host");
        };
        container.appendChild(addBtn);
      }
      return;
    }

    state.hostActions.forEach(action => {
      const wrap = document.createElement("div");
      wrap.style.display = "flex";
      wrap.style.flexWrap = "wrap";
      wrap.style.gap = "0.25rem";
      wrap.style.alignItems = "center";
      wrap.style.justifyContent = "center";

      const runBtn = document.createElement("button");
      runBtn.className = "btn";
      runBtn.textContent = action.label || "Command";
      runBtn.onclick = () => ensureAdminThen(() => runHostAction(action.id));
      wrap.appendChild(runBtn);

      if (editMode) {
        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-icon-only";
        editBtn.innerHTML = ICON_BTN_EDIT;
        editBtn.setAttribute("aria-label", "Edit");
        editBtn.title = "Edit";
        editBtn.onclick = () => {
          mode.action = "edit";
          mode.id = action.id;
          showModal("host", action.id);
        };
        wrap.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-icon-only";
        delBtn.innerHTML = ICON_BTN_DELETE;
        delBtn.setAttribute("aria-label", "Delete");
        delBtn.title = "Delete";
        delBtn.onclick = () => deleteHostAction(action.id);
        wrap.appendChild(delBtn);
      }

      container.appendChild(wrap);
    });

    if (editMode) {
      const addBtn = document.createElement("button");
      addBtn.className = "btn";
      addBtn.textContent = "+ Add Cmd";
      addBtn.onclick = () => {
        mode.action = "create";
        mode.id = null;
        showModal("host");
      };
      container.appendChild(addBtn);
    }
  }

  // ==============================
  // HOST INFO (info.sh)
  // ==============================
  function fmtShort(ts){
    if (!ts) return "â€”";
    const d = new Date(ts);
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  async function loadHostInfo() {
    try {
      const res = await fetch(API_BASE + "/hostinfo", { credentials: "include" });
      const info = await res.json();

      const upd = document.getElementById("host-updated");
      const box = document.getElementById("host-stats");
      if (!box) return;

      const chips = [];

      if (info.ip) chips.push(`<span class="host-chip"><b>IP</b>${info.ip}</span>`);
      if (Number.isFinite(info.rssi)) chips.push(`<span class="host-chip"><b>RSSI</b>${info.rssi} dBm</span>`);
      if (info.ssid) chips.push(`<span class="host-chip"><b>SSID</b>${info.ssid}</span>`);
      if (info.health) chips.push(`<span class="host-chip"><b>Battery</b>${info.health}</span>`);
      if (info.status) chips.push(`<span class="host-chip"><b>Status</b>${info.status}</span>`);
      if (Number.isFinite(info.temperature)) chips.push(`<span class="host-chip"><b>Temp</b>${info.temperature}Â°C</span>`);
      if (Number.isFinite(info.percentage)) chips.push(`<span class="host-chip"><b>Charge</b>${info.percentage}%</span>`);

      if (!chips.length) chips.push(`<span class="host-chip">No data</span>`);

      box.innerHTML = chips.join("");

      upd.textContent = info.ok
        ? `Updated ${fmtShort(info.updatedAt)}`
        : `Last attempt ${fmtShort(info.updatedAt)} â€” error`;
    } catch {
      const upd = document.getElementById("host-updated");
      const box = document.getElementById("host-stats");
      if (upd) upd.textContent = "Host info unavailable";
      if (box) box.innerHTML = `<span class="host-chip">No data</span>`;
    }
  }

  // ==============================
  // MANUAL REFRESH BUTTON
  // ==============================
  refreshBtn.addEventListener("click", async () => {
    try {
      refreshBtn.disabled = true;
      refreshBtn.setAttribute("aria-busy", "true");
      refreshBtn.title = "Refreshing...";
      await apiPOSTNoBody("/refresh");
      await loadStateFromServer();
      await loadHostInfo();
    } finally {
      refreshBtn.disabled = false;
      refreshBtn.setAttribute("aria-busy", "false");
      refreshBtn.title = "Refresh";
    }
  });

  // ==============================
  // AUTO REFRESH
  // ==============================
  async function refreshLoop() {
    await loadStateFromServer();
  }

  // ==============================
  // HEALTH PAGE
  // ==============================
  function showHomeUI() {
    if (homePage) homePage.classList.remove("hidden");
    if (healthPage) healthPage.classList.add("hidden");
  }

  function showHealthUI() {
    if (homePage) homePage.classList.add("hidden");
    if (healthPage) healthPage.classList.remove("hidden");
  }

  function fmtBytes(bytes) {
    const n = Number(bytes);
    if (!Number.isFinite(n)) return "â€”";
    const units = ["B", "KB", "MB", "GB", "TB"];
    let v = n;
    let u = 0;
    while (v >= 1024 && u < units.length - 1) {
      v /= 1024;
      u++;
    }
    const digits = u === 0 ? 0 : (v >= 100 ? 0 : v >= 10 ? 1 : 2);
    return `${v.toFixed(digits)} ${units[u]}`;
  }

  function fmtUptime(seconds) {
    const s = Math.max(0, Math.floor(Number(seconds) || 0));
    const d = Math.floor(s / 86400);
    const h = Math.floor((s % 86400) / 3600);
    const m = Math.floor((s % 3600) / 60);
    if (d > 0) return `${d}d ${h}h ${m}m`;
    if (h > 0) return `${h}h ${m}m`;
    return `${m}m`;
  }

  function setBar(el, pct) {
    if (!el) return;
    const p = Number.isFinite(Number(pct)) ? Number(pct) : 0;
    const clamped = Math.max(0, Math.min(100, p));
    el.style.width = `${clamped}%`;
  }

  function setRing(circleEl, pct) {
    if (!circleEl) return;
    const p = Number.isFinite(Number(pct)) ? Number(pct) : 0;
    const clamped = Math.max(0, Math.min(100, p));
    const r = 52;
    const c = 2 * Math.PI * r;
    circleEl.style.strokeDasharray = `${c}`;
    circleEl.style.strokeDashoffset = `${c * (1 - clamped / 100)}`;

    if (clamped >= 85) circleEl.style.stroke = "#ef4444";
    else if (clamped >= 60) circleEl.style.stroke = "#f59e0b";
    else circleEl.style.stroke = "#10b981";
  }

  function showHealthError(text) {
    if (!healthErrorEl) return;
    if (!text) {
      healthErrorEl.classList.add("hidden");
      healthErrorEl.textContent = "";
      return;
    }
    healthErrorEl.classList.remove("hidden");
    healthErrorEl.textContent = text;
  }

  async function loadHealthOnce() {
    const res = await fetch("/api/health", { cache: "no-store" });
    const j = await res.json().catch(() => null);
    if (!res.ok || !j || !j.ok) {
      throw new Error((j && j.error) ? j.error : `HTTP ${res.status}`);
    }
    return j;
  }

  function setHint(el, hint) {
    if (!el) return;
    el.textContent = hint ? String(hint) : "";
  }

  async function renderHealth() {
    try {
      const data = await loadHealthOnce();
      showHealthError("");

      if (healthUpdatedEl) healthUpdatedEl.textContent = `Updated ${fmtShort(data.updatedAt)}`;

      if (healthHostnameEl) healthHostnameEl.textContent = data.system?.hostname || "â€”";
      if (healthOsEl) {
        const osLine = [data.system?.platform, data.system?.release, data.system?.arch]
          .filter(Boolean)
          .join(" ");
        healthOsEl.textContent = osLine || "â€”";
      }
      if (healthUptimeEl) healthUptimeEl.textContent = fmtUptime(data.system?.uptimeSec);
      if (healthIpEl) healthIpEl.textContent = data.network?.ipv4 || "â€”";

      const cpuPct = data.cpu?.usagePercent;
      if (healthCpuPctEl) healthCpuPctEl.textContent = Number.isFinite(cpuPct) ? `${cpuPct}%` : "â€”%";
      if (healthCpuLoadEl) {
        const la = Array.isArray(data.cpu?.loadavg) ? data.cpu.loadavg : [];
        const loadText = la.length ? la.slice(0, 3).map(v => Number(v).toFixed(2)).join(" / ") : "â€”";
        healthCpuLoadEl.textContent = loadText;
      }
      setRing(healthCpuRingEl, Number.isFinite(cpuPct) ? cpuPct : 0);
      const cpuHint = data.cpu?.hint || (Number.isFinite(cpuPct) ? "" : "CPU usage unavailable");
      setHint(healthCpuNoteEl, cpuHint);

      const memPct = data.memory?.usedPercent;
      setBar(healthRamBarEl, Number.isFinite(memPct) ? memPct : 0);
      if (healthRamTextEl) {
        const used = fmtBytes(data.memory?.usedBytes);
        const total = fmtBytes(data.memory?.totalBytes);
        const pctText = Number.isFinite(memPct) ? `${memPct}%` : "â€”%";
        healthRamTextEl.textContent = `${used} / ${total} (${pctText})`;
      }
      setHint(healthRamNoteEl, Number.isFinite(memPct) ? "" : "Memory usage unavailable");

      const storage = data.storage || data.disk || null;
      if (storage?.available) {
        const diskPct = storage?.usedPercent;
        setBar(healthDiskBarEl, Number.isFinite(diskPct) ? diskPct : 0);
        if (healthDiskTextEl) {
          const used = fmtBytes(storage?.usedBytes);
          const total = fmtBytes(storage?.totalBytes);
          const pctText = Number.isFinite(diskPct) ? `${diskPct}%` : "â€”%";
          const where = storage?.mount || storage?.path || "";
          healthDiskTextEl.textContent = where
            ? `${used} / ${total} (${pctText}) â€” ${where}`
            : `${used} / ${total} (${pctText})`;
        }
        setHint(healthDiskNoteEl, "");
      } else {
        setBar(healthDiskBarEl, 0);
        if (healthDiskTextEl) healthDiskTextEl.textContent = "Unavailable";
        setHint(healthDiskNoteEl, storage?.hint || "Storage info unavailable");
      }

      if (data.battery?.available) {
        const pct = data.battery?.percent;
        const st = data.battery?.status;
        const pctText = Number.isFinite(pct) ? `${pct}%` : "â€”%";
        if (healthBatteryEl) healthBatteryEl.textContent = st ? `${pctText} (${st})` : pctText;
        setHint(healthSysNoteEl, "");
      } else {
        if (healthBatteryEl) healthBatteryEl.textContent = "Unavailable";
        setHint(healthSysNoteEl, data.battery?.hint || "");
      }
    } catch (e) {
      showHealthError(`Health API unavailable: ${e && e.message ? e.message : e}`);
    }
  }

  async function initHealthPage() {
    if (healthRefreshBtn) {
      healthRefreshBtn.addEventListener("click", async () => {
        healthRefreshBtn.disabled = true;
        healthRefreshBtn.setAttribute("aria-busy", "true");
        healthRefreshBtn.title = "Refreshing...";
        try {
          await renderHealth();
        } finally {
          healthRefreshBtn.disabled = false;
          healthRefreshBtn.setAttribute("aria-busy", "false");
          healthRefreshBtn.title = "Refresh";
        }
      });
    }

    await renderHealth();
    setInterval(renderHealth, 10000);
  }

  // ==============================
  // INIT
  // ==============================
  (async function init() {
    await refreshBrandTextFromServer();

    if (isHealthRoute) {
      showHealthUI();
      await initHealthPage();
      return;
    }

    showHomeUI();
    openBtn.classList.add("hidden");
    // updateBatteryFormDisabled();


const adminStatus = await fetch("/api/admin/status").then(r => r.json());

if (!adminStatus.initialized) {
  adminOverlay.classList.remove("hidden");
  adminPassInput.placeholder = "Set admin password";
  if (adminStatusEl) {
    adminStatusEl.textContent = "Set a new admin password (min 6 characters).";
    adminStatusEl.classList.remove("error");
  }
}


    await loadStateFromServer();
    await loadHostInfo();

    setInterval(refreshLoop, 10000);
    setInterval(loadHostInfo, 60000);
  })();





// ==============================
// WOL TYPE SWITCH
// ==============================
const wolTypeSelect = document.getElementById("wol-type");
const wolBasicBox   = document.getElementById("wol-basic");
const wolMikrotikBox= document.getElementById("wol-mikrotik");
const wolWadEspBox  = document.getElementById("wol-wadesp");
const wolSshSection = document.getElementById("wol-ssh-section");

function updateWolTypeUI() {
  const t = wolTypeSelect.value;

  wolBasicBox.classList.add("hidden");
  wolMikrotikBox.classList.add("hidden");
  wolWadEspBox.classList.add("hidden");

  if (t === "basic") {
    wolBasicBox.classList.remove("hidden");
  }

  if (t === "mikrotik") {
    wolMikrotikBox.classList.remove("hidden");
  }

  if (t === "wadesp") {
    wolWadEspBox.classList.remove("hidden");
  }
}


wolTypeSelect.addEventListener("change", updateWolTypeUI);
updateWolTypeUI();


const pwdOldInput   = document.getElementById("pwd-old");
const pwdNewInput   = document.getElementById("pwd-new");
const pwdSaveBtn    = document.getElementById("pwd-save-btn");
const pwdSaveStatus = document.getElementById("pwd-save-status");

pwdSaveBtn.addEventListener("click", async () => {
  if (!editMode) return;

  const oldPw = pwdOldInput.value.trim();
  const newPw = pwdNewInput.value.trim();

  if (!newPw || newPw.length < 6) {
    pwdSaveStatus.textContent = "Password too short";
    return;
  }

  pwdSaveStatus.textContent = "Saving...";

  const res = await apiJSON("PUT", "/admin/password", {
    oldPassword: oldPw,
    newPassword: newPw
  });

  if (res && res.ok) {
    pwdSaveStatus.textContent = "Password changed";
    pwdOldInput.value = "";
    pwdNewInput.value = "";
  } else {
    pwdSaveStatus.textContent = "Wrong current password";
  }
});


</script>
</body>
</html>
